name: Setup VPS

on:
  workflow_dispatch:
    inputs:
      vps_ip:
        description: "VPS IP address"
        required: true
        type: string
      ssh_port:
        description: "SSH port for the new configuration"
        required: true
        default: "22"
        type: string

env:
  ROOT_SSH_PRIVATE_KEY: ${{ secrets.ROOT_SSH_PRIVATE_KEY }}
  ROOT_SSH_PUBLIC_KEY: ${{ secrets.ROOT_SSH_PUBLIC_KEY }}

jobs:
  setup-vps:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ env.ROOT_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ inputs.vps_ip }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Create Ansible inventory
        run: |
          cat > /tmp/inventory << EOF
          [vps-servers]
          vps-server ansible_host=${{ inputs.vps_ip }} ansible_user=root ansible_ssh_private_key_file=~/.ssh/id_rsa
          EOF

      - name: Run Ansible playbook
        run: |
          ansible-playbook -i /tmp/inventory setup_vps/ansible/install-docker.yml \
            --extra-vars "ssh_port=${{ inputs.ssh_port }} root_public_key='${{ env.ROOT_SSH_PUBLIC_KEY }}'"

      - name: Display connection info
        if: success()
        run: |
          echo "## VPS Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Connect to your VPS:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "ssh -p ${{ inputs.ssh_port }} root@${{ inputs.vps_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Next step: init the all needed github action secret and variable" >> $GITHUB_STEP_SUMMARY
